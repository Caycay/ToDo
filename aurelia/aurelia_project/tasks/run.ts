import * as gulp from 'gulp';
import * as browserSync from 'browser-sync';
import * as historyApiFallback from 'connect-history-api-fallback/lib';
import {CLIOptions} from 'aurelia-cli';
import * as project from '../aurelia.json';
import build from './build';
import watch from './watch';

let serve = gulp.series(
  build,
  done => {
    browserSync({
      online: false,
      open: false,
      port: 9000,
      logLevel: 'silent',
      server: {
        baseDir: [project.platform.baseDir],
        middleware: [historyApiFallback(), function(req, res, next) {
          res.setHeader('Access-Control-Allow-Origin', '*');
          next();
        }]
      }
    }, function (err, bs) {
      if (err) return done(err);
      let urls = bs.options.get('urls').toJS();
      log(`Application Available At: ${urls.local}`);
      log(`BrowserSync Available At: ${urls.ui}`);
      log(KITTY);
      done();
    });
  }
);

function log(message) {
  console.log(message);
}

function reload() {
  log('Refreshing the browser');
  browserSync.reload();
}

let run;

if (CLIOptions.hasFlag('watch')) {
  run = gulp.series(
    serve,
    done => { watch(reload); done(); }
  );
} else {
  run = serve;
}

export default run;

const FROG=`
$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$
$$$$$$$$$P"   .   ^*$$$$$$$"       "*$$$$$$$$$$$
$$$$$$$P  e$$$$$$$e  *$$$" z$$$$$$$e  *$$$$$$$$$
$$$$$$F d$$$$$$$$$$$k 4$ :$$$$$$$$$$$k ?$$$$$$$$
$$$$$E d$$$$$$$$$$$$$k  :$$$$$$$$$$$$$k 9$$$$$$$
$$$$$> $$$$$$$$$F  ^$$  $$" ^$$$$$$$$$$>'$$$$$$$
$$$$$>'$$$$$$$$E    '$> $>   '$$$$$$$$$> $$$$$$$
$$$$$> $$$$$$$$$u  .$$  $N   @$$$$$$$$$~:$$$$$$$
$$$$$$ '$$$$$$$$$$$$$"  '$$$$$$$$$$$$$F 9$$$$$$$
$$$$$$N ^$$$$$$$$$$$" dN '$$$$$$$$$$$"  ^$$$$$$$
$$$$$$  . ^*$$$$$*" .$$$$. ^*$$$$$$"  @$L "$$$$$
$$$$$ .$$$e.     .e$$$$$$$$c.      u@$$$$& ?$$$$
$$$$  $$$$$$$$$$$$$$$$$$$$$$$$$$$$$$"'"$$$K 9$$$
$$$E 3$$F   '$$$$$$$$$$$$$$$$$$$$$$     $$$ '$$$
$$$E 3$$     9$$$$$$$$$$$$$$$$$$$$$     $$$ '$$$
$$$$ ^$$N.  d$$$$$$$$$$$$$$$$$$$$$$$u.u$$$$ J$$$
$$$$L R$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$  $$$$
$$$$$r #$$$$$$  ^*$$$$$$$$$$$$# '$$$$$$$$  @$$$$
$$$$$$k '*$$$$$$c  ^*$$$$$*"  .d$$$$$$$" .$$$$$$
$$$$$$$$e    ""*$$$c  ^"  .z$$$$*#"    z$$$$$$$$
$$$$$"   uze  c.                .zc  .   "$$$$$$
$$$" .@$$$$  $$!!!^"*E!!!P" '!!9$$$: 4$$N. ^$$$$
$N.  "$$$$  $$$!!>           !!9$$$!  9$$$$. ?$$
$$$$E @$$  d$$$!!L   .:!:.   !!9$$$!! '$$$$#  ?$
$$$$L   " :9$$$!!!9$$E!!!$$$!!!9$$$!!  $$$ :e@$$
$$$$$$>   !9$$$!!!9$$E!!!$$$!!!9$$$!!>     $$$$$
$$$$$$$E  '*$$$!!!9$$E!!!$$$!!!9$*"    :$$$$$$$$
$$$$$$$$  c.      '^""'''"'      .zd$$k 4$$$$$$$
$$$$$$$F J$$$$$$$$$beee -d$$$$$$$$$$$$"  9$$$$$$
$$$$$$$L  "    "*"" '#F  3*"'^"#"     ube$$$$$$$
$$$$$$$$$$$$$$$c.zd$b.  L .e@Weu.@$$$$$$$$$$$$$$
`;
const KITTY = `
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!'   '4!!!!!!!!!!~4!!!!!!!!!!!!!!!!!
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!   <~:   ~!!!~   ..  4!!!!!!!!!!!!!!!
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!  ~~~~~~~  '  ud$$$$$  !!!!!!!!!!!!!!!
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!  ~~~~~~~~~: ?$$$$$$$$$  !!!!!!!!!!!!!!
!!!!!!!!!!!'     ''~!!!!!!!!!!!!!!  ~~~~~          "*$$$$$k '!!!!!!!!!!!!!
!!!!!!!!!!  $$$$$bu.  '~!~'     .  '~~~~      :~~~~          '4!!!!!!!!!!!
!!!!!!!!!  $$$$$$$$$$$c  .zW$$$$$E ~~~~      ~~~~~~~~  ~~~~~:  '!!!!!!!!!!
!!!!!!!!! d$$$$$$$$$$$$$$$$$$$$$$E ~~~~~    '~~~~~~~~    ~~~~~  !!!!!!!!!!
!!!!!!!!> 9$$$$$$$$$$$$$$$$$$$$$$$ '~~~~~~~ '~~~~~~~~     ~~~~  !!!!!!!!!!
!!!!!!!!> $$$$$$$$$$$$$$$$$$$$$$$$b   ~~~    '~~~~~~~     '~~~ '!!!!!!!!!!
!!!!!!!!> $$$$$$$$$$$$$$$$$$$$$$$$$$$cuuue$$N.   ~        ~~~  !!!!!!!!!!!
!!!!!!!!! **$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$Ne  ~~~~~~~~  '!!!!!!!!!!!
!!!!!!!!!  J$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$N  ~~~~~  zL '!!!!!!!!!!
!!!!!!!!  d$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$c     z$$$c '!!!!!!!!!
!!!!!!!> <$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$> 4!!!!!!!!
!!!!!!!  $$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$  !!!!!!!!
!!!!!!! <$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$*"   ....:!!
!!!!!!~ 9$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$e@$N '!!!!!!!
!!!!!!  9$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$  !!!!!!!
!!!!!!  $$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$""$$$$$$$$$$$~ ~~4!!!!
!!!!!!  9$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$    $$$$$$$Lue  :::!!!!
!!!!!!> 9$$$$$$$$$$$$" '$$$$$$$$$$$$$$$$$$$$$$$$$$$    $$$$$$$$$$  !!!!!!!
!!!!!!! '$$*$$$$$$$$E   '$$$$$$$$$$$$$$$$$$$$$$$$$$$u.@$$$$$$$$$E '!!!!!!!
!!!!~'   .eeW$$$$$$$$   :$$$$$$$$$$$$$***$$$$$$$$$$$$$$$$$$$$u.    '~!!!!!
!!> .:!h '$$$$$$$$$$$$ed$$$$$$$$$$$$Fz$$b $$$$$$$$$$$$$$$$$$$$$F '!h.  !!!
!!!!!!!!L '$**$$$$$$$$$$$$$$$$$$$$$$ *$$$ $$$$$$$$$$$$$$$$$$$$F  !!!!!!!!!
!!!!!!!!!   d$$$$$$$$$$$$$$$$$$$$$$$$buud$$$$$$$$$$$$$$$$$$$$"  !!!!!!!!!!
!!!!!!! .<!  #$$*"$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$*  :!!!!!!!!!!!
!!!!!!!!!!!!:   d$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$#  :!!!!!!!!!!!!!
!!!!!!!!!!!~  :  '#$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$*"    !!!!!!!!!!!!!!!
!!!!!!!!!!  !!!!!:   ^"**$$$$$$$$$$$$$$$$$$$$**#"     .:<!!!!!!!!!!!!!!!!!
!!!!!!!!!!!!!!!!!!!!!:...                      .::!!!!!!!!!!!!!!!!!!!!!!!!
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!

`;
